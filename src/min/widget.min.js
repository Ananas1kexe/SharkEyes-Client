const API_URL = "https://api.sharkeyes.dev/api/v1/verify";const TOKEN_URL = "https://api.sharkeyes.dev/api/v1/token";
async function fetchWithTimeout(url, options = {}, timeout = 8000) {const controller = new AbortController();const id = setTimeout(() => controller.abort(), timeout);
try {const res = await fetch(url, {...options,signal: controller.signal});return res;} finally {clearTimeout(id);}}function detectBrowser() {let engine = "unknown";let brand = "unknown";if (typeof InstallTrigger !== "undefined") {engine = "gecko";brand = "firefox";}
else if (typeof safari !== "undefined" &&safari.pushNotification &&safari.pushNotification.toString() === "[object SafariRemoteNotification]") {engine = "webkit";brand = "safari";}else if (window.chrome &&typeof window.chrome === "object"){engine = "chromium";if (
navigator.brave &&typeof navigator.brave.isBrave === "function") {brand = "brave";}else if (window.opr &&window.opr.addons) {brand = "opera";}else if (window.StyleMedia) {brand = "edge";}else if (window.chrome.loadTimes ||window.chrome.runtime) {brand = "chrome";}
else {brand = "chromium";}}const automation = {webdriver: navigator.webdriver === true,pluginsEmpty:navigator.plugins && navigator.plugins.length === 0,};return {engine,brand,automation};}async function getServerToken() {try {const res = await fetch(TOKEN_URL); if (!res.ok) return null;const data = await res.json()
return data.token;} catch (err) {return null;}}async function collectClientFingerprints() {const nav = navigator || {};const touch = ('ontouchstart' in window) || (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);let webglInfo = null;try {const canvas = document.createElement('canvas');const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');if (gl) {
const dbgInfo = gl.getExtension('WEBGL_debug_renderer_info');if (dbgInfo) {webglInfo = {vendor: gl.getParameter(dbgInfo.UNMASKED_VENDOR_WEBGL),renderer: gl.getParameter(dbgInfo.UNMASKED_RENDERER_WEBGL)};} else {
webglInfo = {vendor: gl.getParameter(gl.VENDOR),renderer: gl.getParameter(gl.RENDERER)};}}} catch (e) {webglInfo = { error: e.message };}let storageTest = false;try {const key = "sharkeyes_temp_storage_test";localStorage.setItem(key, "1");storageTest = localStorage.getItem(key) === "1";localStorage.removeItem(key);} catch(e) {
storageTest = false;}const isPlaywrightFlag = (() => {try {if (window._playwright || window.__playwright || window.__pw) return true;if (window.__pw_manual || window.__PW_INSTANCE) return true;if (window.__PLAYWRIGHT_EVALUATION__) return true;const windowProps = Object.getOwnPropertyNames(window);if (windowProps.some(p => /playwright|__pw|__PW/i.test(p))) return true;if (navigator.webdriver === true) return true;
if (typeof navigator.userAgent === 'string' && /playwright/i.test(navigator.userAgent)) return true;return false;} catch (e) { return true; }})();const browserType = detectBrowser();return {userAgent: nav.userAgent,webdriver: !!nav.webdriver,touch,webgl: webglInfo,
storageTest,isPlaywright: isPlaywrightFlag,browserType};}(function(){const startTime = performance.now();const MAX_EVENTS = 150; const events = [];let lastMove = 0;const isHeadless = navigator.webdriver;const interactionStats = {mouseMoves: 0,clicks: 0,keypresses: 0,scrolls: 0,touches: 0,inputs: 0};
function record(type) {if (events.length >= MAX_EVENTS) return;const now = performance.now();const timeSinceStart = now - startTime;events.push({type,t: timeSinceStart});if (type === "mousemove") interactionStats.mouseMoves++;else if (type === "click") interactionStats.clicks++;else if (type === "keydown") interactionStats.keypresses++;else if (type === "scroll") interactionStats.scrolls++;
else if (type.startsWith("touch")) interactionStats.touches++;else if (type === "input") interactionStats.inputs++;}window.addEventListener("mousemove", () => {const now = performance.now();if (now - lastMove > 100) {record("mousemove");lastMove = now;}}, {passive:true});document.addEventListener("click", () => record("click"));document.addEventListener("keydown", () => record("keydown"));window.addEventListener("scroll", () => record("scroll"));
document.addEventListener("focus", () => record("focus"));document.addEventListener("blur", () => record("blur"));document.addEventListener("input", () => record("input"));document.addEventListener("touchstart", () => record("touchstart"));document.addEventListener("touchend", () => record("touchend"));document.addEventListener("touchmove", () => record("touchmove"));document.addEventListener("paste", () => record("paste"));document.addEventListener("submit", async function(e){
const form = e.target;if (!form.hasAttribute("data-sharkeyes")) return;e.preventDefault();const submitBtn = form.querySelector('button[type="submit"]');const originalText = submitBtn ? submitBtn.textContent : '';if (submitBtn) {submitBtn.disabled = true;}try {const token = await getServerToken();const clientInfo = await collectClientFingerprints();const meta = {time_on_page_ms: Math.round(performance.now() - startTime),screen_w: window.screen.width,
screen_h: window.screen.height,pixel_ratio: window.devicePixelRatio || 1,inputs_count: form.querySelectorAll("input,textarea,select").length,headless: isHeadless,screen_vs_window: {screenW: window.screen.width,screenH: window.screen.height,innerW: window.innerWidth,innerH: window.innerHeight},widget_type: "invisible",interaction_stats: interactionStats,clientInfo};const body = { events, meta, token,};const res = await fetch(API_URL, {method: "POST",headers: {"Content-Type": "application/json"},
body: JSON.stringify(body)});if (res.ok) {form.submit();} else {const data = await res.json().catch(() => ({}));const skyId = (data.detail?.sky_id ?? data.sky_id) ?? "?";const score = (data.detail?.score ?? data.score) ?? "?";showSharkAlert(skyId, score, "https://sharkeyes.dev/");}} catch (err) {console.error("Verification error:", err);alert("Verification error. Please try again later.");} finally {
if (submitBtn) {submitBtn.disabled = false;submitBtn.textContent = originalText;}}});function injectStyles() {if (document.getElementById("sharkeyes-alert-style")) return;const style = document.createElement("style");style.id = "sharkeyes-alert-style";style.textContent = `.shk-alert {position: fixed;top: 50%;left: 50%;transform: translate(-50%, -50%);background: #ffffff;border-radius: 12px;box-shadow: 0 0 25px rgba(0,0,0,0.25);
padding: 20px 25px;z-index: 99999;font-family: system-ui, sans-serif;text-align: center;width: 320px;animation: fadeIn .3s ease;}.shk-alert h3 {margin: 0 0 10px;color: #e53935;}.shk-alert a {color: #1976d2;text-decoration: none;font-weight: 500;}.shk-alert a:hover {text-decoration: underline;}.shk-alert button {margin-top: 12px;background: #1976d2;border: none;color: white;padding: 8px 14px;border-radius: 6px;
cursor: pointer;font-size: 14px;}.shk-alert button:hover {background: #1565c0;}@keyframes fadeIn {from { opacity: 0; transform: translate(-50%, -40%); }to { opacity: 1; transform: translate(-50%, -50%); }}`;document.head.appendChild(style);}function showSharkAlert(skyId, score, link) {injectStyles();const old = document.getElementById("sharkeyes-alert");if (old) old.remove();const alertBox = document.createElement("div");alertBox.id = "sharkeyes-alert";
alertBox.className = "shk-alert";alertBox.innerHTML = `<h3>‚ùå Test Failed</h3><p>Sky ID: <b id="shk-id-val"></b></p><p>Score: <b id="shk-score-val"></b></p>${link ? `<p><a href="#" id="shk-link" target="_blank">SharkEyes Security</a></p>` : ""}<button id="shk-close">Close</button>`;alertBox.querySelector("#shk-id-val").textContent = skyId;alertBox.querySelector("#shk-score-val").textContent = score;if (link) {const linkEl = alertBox.querySelector("#shk-link");
linkEl.href = link;}alertBox.querySelector("#shk-close").onclick = () => alertBox.remove();document.body.appendChild(alertBox);}})();